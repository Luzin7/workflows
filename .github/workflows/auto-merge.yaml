name: Auto Create PRs for Clients

on:
  push:
    tags:
      - 'release*'

jobs:
  create_prs:
    runs-on: ubuntu-latest
    steps:
      - name: Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"

      - name: Checkout main
        run: |
          git checkout main
          git pull origin main

      - name: Define client branches
        id: define_branches
        run: |
          BRANCHES="cliente1 cliente2 cliente3"  # Substitua com os nomes reais
          echo "Branches definidas: $BRANCHES"
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT

      - name: Create PRs for clients
        run: |
          IFS=' ' read -ra BRANCHES <<< "${{ steps.define_branches.outputs.branches }}"
          
          for branch in "${BRANCHES[@]}"; do
            echo "=== Iniciando processo para $branch ==="
            
            git checkout $branch
            git pull origin $branch
            
            PR_BRANCH="auto-merge/main-to-${branch}"
            git checkout -b $PR_BRANCH main
            
            if git merge $branch --no-commit --no-ff; then
              git merge --abort
              echo "‚úÖ Branch $branch preparada para PR"
              echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV
              echo "TARGET_BRANCH=$branch" >> $GITHUB_ENV
              echo "CONFLICT=false" >> $GITHUB_ENV
            else
              echo "‚ùå Conflito detectado em $branch"
              git merge --abort
              echo "PR_BRANCH=$PR_BRANCH" >> $GITHUB_ENV
              echo "TARGET_BRANCH=$branch" >> $GITHUB_ENV
              echo "CONFLICT=true" >> $GITHUB_ENV
            fi
          done

      - name: Create Pull Request
        if: always()
        uses: peter-evans/create-pull-request@v5
        with:
          branch: ${{ env.PR_BRANCH }}
          base: ${{ env.TARGET_BRANCH }}
          title: "ATUALIZA√á√ÉO - ${{ github.ref_name }}: main ‚Üí ${{ env.TARGET_BRANCH }}"
          body: |
            Este PR foi criado automaticamente para propagar as mudan√ßas da main para ${{ env.TARGET_BRANCH }}.
            
            ## üîç O que fazer:
            1. Revise as mudan√ßas
            2. Assine o PR
            3. Fa√ßa merge do PR
            
            ## üìù Detalhes:
            - Branch origem: `main`
            - Branch destino: `${{ env.TARGET_BRANCH }}`
            - Tag que disparou: `${{ github.ref_name }}`
            - Conflitos: ${{ env.CONFLICT == 'true' && 'Sim' || 'N√£o' }}
            
            ---
            
            Atenciosamente,
            
            [Luan Victor]
          labels: |
            automated-pr
            needs-review

      - name: Success Summary
        if: success()
        run: |
          echo "=== üéâ Resumo da Execu√ß√£o ==="
          echo "Tag que disparou: ${{ github.ref_name }}"
          echo "Branches processadas: ${{ steps.define_branches.outputs.branches }}"
          echo "‚úÖ PRs criados para todas as branches!"

      - name: Failure Summary
        if: failure()
        run: |
          echo "=== ‚ùå Resumo da Execu√ß√£o ==="
          echo "Tag que disparou: ${{ github.ref_name }}"
          echo "Branches processadas: ${{ steps.define_branches.outputs.branches }}"
          echo "‚ö†Ô∏è Falha ao criar PRs para algumas branches."